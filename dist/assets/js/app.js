(()=>{const API = window.API_BASE_URL || localStorage.getItem("API_BASE_URL")|| "";const fmtQ = n => new Intl.NumberFormat('es-GT',{style:'currency',currency:'GTQ'}).format(n||0);const qs = s => document.querySelector(s);const qsa = s => Array.from(document.querySelectorAll(s));const state ={cart:JSON.parse(localStorage.getItem("cart")||"[]")};function saveCart(){localStorage.setItem("cart",JSON.stringify(state.cart));updateCartCount();}function updateCartCount(){const el=qs("#cart-count");if(el)el.textContent = state.cart.reduce((a,i)=>a+i.qty,0);}function addToCart(p,qty=1){const i = state.cart.findIndex(x=>x.id===p.id && x.variant_id===p.variant_id);if(i>=0)state.cart[i].qty += qty;else state.cart.push({id:p.id,name:p.name,price:p.price,variant_id:p.variant_id||null,qty});saveCart();alert("Agregado al carrito");}async function fetchJSON(path,params={}){const url = API + path +(params && Object.keys(params).length ?("?" + new URLSearchParams(params)):"");const r = await fetch(url);return r.json();}async function renderLatest(){const grid = qs("#grid-products[data-source='latest']");if(!grid)return;const data = await fetchJSON("/api/products",{limit:8,order:"published_at.desc"});grid.innerHTML = data.items.map(card).join("");wireAddButtons(data.items);}function card(p){const img =(p.images && p.images[0])? p.images[0].public_url:"assets/img/placeholder.webp";return `<article class="card"><a href="producto.html?id=${p.id}"><img loading="lazy" src="${img}" alt=""></a> <a href="producto.html?id=${p.id}"><strong>${p.name}</strong></a> <span class="price">${fmtQ(p.price_offer||p.price)}</span> <button class="btn add" data-id="${p.id}">Agregar</button></article>`;}function wireAddButtons(items){qsa(".add").forEach(btn=>{btn.addEventListener("click",()=>{const p = items.find(x=>String(x.id)===String(btn.dataset.id));addToCart({id:p.id,name:p.name,price:(p.price_offer||p.price)});});});}async function renderList(){const grid = qs("#grid-products");if(!grid)return;const params = Object.fromEntries(new URLSearchParams(location.search));const data = await fetchJSON("/api/products",params);grid.innerHTML = data.items.map(card).join("");wireAddButtons(data.items);// brands/cats const brands = qs("#brand"),cats=qs("#cat");if(brands && data.brands){brands.innerHTML = '<option value="">Todas las marcas</option>' + data.brands.map(b=>`<option>${b.name}</option>`).join("");}if(cats && data.categories){cats.innerHTML = '<option value="">Todas las categorías</option>' + data.categories.map(c=>`<option>${c.name}</option>`).join("");}}async function renderDetail(){const el = qs("#product-detail");if(!el)return;const id = new URLSearchParams(location.search).get("id");if(!id)return;const p = await fetchJSON(`/api/products/${id}`);const img =(p.images && p.images[0])? p.images[0].public_url:"assets/img/placeholder.webp";el.innerHTML = `<div class="grid"><div><img loading="lazy" src="${img}" alt=""></div><div> <h1>${p.name}</h1><p class="muted">${p.brand?.name||""}</p><p>${p.description||""}</p> <p class="price">${fmtQ(p.price_offer||p.price)}</p> <button class="btn" id="add1">Agregar al carrito</button> <p><a rel="nofollow" target="_blank" href="https://wa.me/50255555555?text=${encodeURIComponent("Consulta sobre "+p.name)}">WhatsApp</a></p> </div></div>`;qs("#add1").addEventListener("click",()=> addToCart({id:p.id,name:p.name,price:(p.price_offer||p.price)}));}function renderCart(){const wrap = qs("#cart-items");if(!wrap)return;if(!state.cart.length){wrap.innerHTML = "<p>Tu carrito está vacío.</p>";return;}wrap.innerHTML = state.cart.map((i,idx)=>`<div class="card"><strong>${i.name}</strong> <div class="muted">Cant:${i.qty}</div><div>${fmtQ(i.price*i.qty)}</div> <button data-rm="${idx}">Quitar</button></div>`).join("");qsa("[data-rm]").forEach(b=>b.onclick=()=>{state.cart.splice(Number(b.dataset.rm),1);saveCart();renderCart();});qs("#cart-total")&&(qs("#cart-total").textContent = fmtQ(state.cart.reduce((a,i)=>a+i.price*i.qty,0)));}function submitCheckout(){const form = qs("#checkout-form");if(!form)return;form.addEventListener("submit",async(e)=>{e.preventDefault();if(!state.cart.length){alert("Agrega productos al carrito");return;}const payload = Object.fromEntries(new FormData(form).entries());payload.items = state.cart;const r = await fetch(API + "/api/orders/checkout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});if(!r.ok){alert("Error en checkout");return;}const data = await r.json();state.cart = [];saveCart();location.href = "index.html";});}updateCartCount();renderLatest();renderList();renderDetail();renderCart();submitCheckout();})();