name: Provision Database
on:
  workflow_dispatch:

jobs:
  provision:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary

      - name: Validate DATABASE_URL
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          python - <<'PY'
          import os, sys
          url = os.getenv("DATABASE_URL","").strip()
          if not url.startswith("postgresql://"):
              print("❌ DATABASE_URL inválida. Debe ser UNA sola línea que empiece por 'postgresql://'")
              print("Ejemplo: postgresql://usuario:password@db.xxxxx.supabase.co:5432/postgres")
              sys.exit(1)
          print("✅ DATABASE_URL con formato correcto")
          PY

      - name: Run migrations and seed
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "🔹 Conectando a la base..."
          python - <<'PY'
          import psycopg2, os, glob
          conn = psycopg2.connect(os.getenv("DATABASE_URL"))
          conn.autocommit = True
          cur = conn.cursor()
          for f in sorted(glob.glob("supabase/migrations/*.sql")):
              print(f"🏗️ Ejecutando {f}")
              with open(f, "r", encoding="utf-8") as fh:
                  cur.execute(fh.read())
          cur.close(); conn.close()
          print("✅ Migraciones completadas correctamente")
          PY
