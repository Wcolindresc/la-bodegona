name: Provision Database
on:
  workflow_dispatch:
    inputs:
      run_seed:
        description: "Run seed data (true/false)"
        required: true
        default: "true"
        type: boolean

jobs:
  provision:
    name: Provision Supabase Database
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary python-dotenv

      - name: Run migrations and seed
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "ðŸ”¹ Conectando a la base..."
          python - <<'PY'
          import psycopg2, os, glob
          conn = psycopg2.connect(os.getenv("DATABASE_URL"))
          cur = conn.cursor()
          path = "supabase/migrations"
          files = sorted(glob.glob(f"{path}/*.sql"))
          for f in files:
              print(f"ðŸ—ï¸ Ejecutando {f}")
              with open(f, "r", encoding="utf8") as sqlf:
                  cur.execute(sqlf.read())
              conn.commit()
          cur.close(); conn.close()
          print("âœ… Migraciones completadas correctamente")
          PY
